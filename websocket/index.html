<div class="diag-item">
    <span class="diag-label">Heartbeat Status:</span>
    <span class="diag-value" id="heartbeatStatus">Enabled (3s interval)</span>
  </div>
  <div class="diag-item">
    <span class="diag-label">Missed Heartbeats:</span>
    <span class="diag-value" id="missedHeartbeats">0</span>
  </div><!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>🔧 Advanced WebSocket Debugger</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #333;
  min-height: 100vh;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: rgba(255,255,255,0.95);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  backdrop-filter: blur(10px);
}
h1 {
  text-align: center;
  color: #4a5568;
  margin-bottom: 30px;
  font-size: 2.2em;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}
.status-card {
  padding: 20px;
  border-radius: 15px;
  text-align: center;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.status-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.connected { 
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}
.disconnected { 
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}
.connecting { 
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}
.error {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-bottom: 25px;
}
button {
  padding: 12px 24px;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s ease;
  min-width: 120px;
}
.btn-primary {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
}
.btn-danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}
.btn-success {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}
.btn-warning {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
.messages-container {
  background: #f8fafc;
  border-radius: 15px;
  border: 1px solid #e2e8f0;
  overflow: hidden;
  margin-bottom: 20px;
}
.messages-header {
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  color: white;
  padding: 15px 20px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#messages {
  height: 300px;
  overflow-y: auto;
  padding: 15px;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.4;
}
.message {
  margin-bottom: 8px;
  padding: 8px 12px;
  border-radius: 8px;
  border-left: 4px solid;
}
.msg-info { 
  background: #e0f2fe; 
  border-left-color: #0ea5e9; 
}
.msg-success { 
  background: #dcfce7; 
  border-left-color: #22c55e; 
}
.msg-error { 
  background: #fef2f2; 
  border-left-color: #ef4444; 
}
.msg-warning { 
  background: #fffbeb; 
  border-left-color: #f59e0b; 
}
.diagnostics {
  background: #f1f5f9;
  padding: 20px;
  border-radius: 15px;
  border: 1px solid #cbd5e1;
}
.diagnostics h3 {
  color: #475569;
  margin-top: 0;
}
.diag-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #e2e8f0;
}
.diag-item:last-child {
  border-bottom: none;
}
.diag-label {
  font-weight: bold;
  color: #64748b;
}
.diag-value {
  color: #1e293b;
  font-family: 'Courier New', monospace;
}
.input-group {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}
input[type="text"] {
  flex: 1;
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}
input[type="text"]:focus {
  outline: none;
  border-color: #3b82f6;
}
</style>
</head>
<body>
<div class="container">
<h1>🔧 Advanced WebSocket Debugger</h1>

<div class="status-grid">
  <div id="connectionStatus" class="status-card disconnected">
    ❌ Not Connected
  </div>
  <div id="readyState" class="status-card disconnected">
    ReadyState: CLOSED
  </div>
  <div id="messageCount" class="status-card connecting">
    Messages: 0 sent / 0 received
  </div>
  <div id="errorCount" class="status-card error">
    Errors: 0
  </div>
</div>

<div class="controls">
  <button class="btn-primary" onclick="connect()">🔌 Connect</button>
  <button class="btn-danger" onclick="disconnect()">🔌 Disconnect</button>
  <button class="btn-success" onclick="sendPing()">🏓 Send Ping</button>
  <button class="btn-warning" onclick="sendTest()">🧪 Send Test</button>
  <button class="btn-primary" onclick="clearMessages()">🗑️ Clear Log</button>
  <button class="btn-success" onclick="toggleHeartbeat()" id="heartbeatBtn">💓 Heartbeat: ON</button>
</div>

<div class="input-group">
  <input type="text" id="customMessage" placeholder="Enter custom JSON message..." value='{"type": "test", "data": "hello"}'>
  <button class="btn-primary" onclick="sendCustom()">📤 Send Custom</button>
</div>

<div class="messages-container">
  <div class="messages-header">
    <span>📋 Connection Log</span>
    <span id="timestamp">Live</span>
  </div>
  <div id="messages"></div>
</div>

<div class="diagnostics">
  <h3>🔍 Connection Diagnostics</h3>
  <div class="diag-item">
    <span class="diag-label">Browser:</span>
    <span class="diag-value" id="browser">Detecting...</span>
  </div>
  <div class="diag-item">
    <span class="diag-label">WebSocket Support:</span>
    <span class="diag-value" id="wsSupport">Checking...</span>
  </div>
  <div class="diag-item">
    <span class="diag-label">Server URL:</span>
    <span class="diag-value" id="serverUrl">ws://localhost:5000/ws</span>
  </div>
  <div class="diag-item">
    <span class="diag-label">Last Error:</span>
    <span class="diag-value" id="lastError">None</span>
  </div>
  <div class="diag-item">
    <span class="diag-label">Connection Duration:</span>
    <span class="diag-value" id="duration">0s</span>
  </div>
  <div class="diag-item">
    <span class="diag-label">Reconnect Attempts:</span>
    <span class="diag-value" id="reconnectCount">0</span>
  </div>
</div>
</div>

<script>
let ws = null;
let messagesSent = 0;
let messagesReceived = 0;
let errorCount = 0;
let connectTime = null;
let reconnectAttempts = 0;
let durationInterval = null;
let autoReconnect = true;
let heartbeatInterval = null;
let heartbeatEnabled = true;
let missedHeartbeats = 0;

// Initialize diagnostics
function initDiagnostics() {
document.getElementById('browser').textContent = navigator.userAgent.split(' ').pop();
document.getElementById('wsSupport').textContent = typeof WebSocket !== 'undefined' ? 'Yes' : 'No';
updateTimestamp();
setInterval(updateTimestamp, 1000);
}

function updateTimestamp() {
document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
}

function log(message, type = 'info') {
const messages = document.getElementById('messages');
const div = document.createElement('div');
div.className = `message msg-${type}`;
div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
messages.appendChild(div);
messages.scrollTop = messages.scrollHeight;

if (type === 'success') messagesReceived++;
if (type === 'error') errorCount++;
updateCounters();
}

function updateStatus(status, message) {
const statusDiv = document.getElementById('connectionStatus');
statusDiv.className = `status-card ${status}`;
statusDiv.textContent = message;

// Update ready state
const readyStateDiv = document.getElementById('readyState');
if (ws) {
const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
readyStateDiv.textContent = `ReadyState: ${states[ws.readyState]}`;
readyStateDiv.className = `status-card ${ws.readyState === 1 ? 'connected' : 'disconnected'}`;
}
}

function updateCounters() {
document.getElementById('messageCount').textContent = `Messages: ${messagesSent} sent / ${messagesReceived} received`;
document.getElementById('errorCount').textContent = `Errors: ${errorCount}`;
document.getElementById('reconnectCount').textContent = reconnectAttempts;
}

function startHeartbeat() {
if (!heartbeatEnabled || heartbeatInterval) return;

log("💓 Starting heartbeat (3s interval)", "info");
heartbeatInterval = setInterval(() => {
if (ws && ws.readyState === WebSocket.OPEN) {
  sendMessage({
    type: "heartbeat",
    timestamp: Date.now(),
    client: "keep-alive"
  });
  
  // Check for missed heartbeats
  missedHeartbeats++;
  if (missedHeartbeats > 3) {
    log("💔 Too many missed heartbeats, connection might be dead", "warning");
  }
  
  document.getElementById('missedHeartbeats').textContent = missedHeartbeats;
}
}, 3000); // Every 3 seconds
}

function stopHeartbeat() {
if (heartbeatInterval) {
clearInterval(heartbeatInterval);
heartbeatInterval = null;
log("💔 Heartbeat stopped", "warning");
}
missedHeartbeats = 0;
document.getElementById('missedHeartbeats').textContent = '0';
}

function toggleHeartbeat() {
heartbeatEnabled = !heartbeatEnabled;
const btn = document.getElementById('heartbeatBtn');
const status = document.getElementById('heartbeatStatus');

if (heartbeatEnabled) {
btn.textContent = "💓 Heartbeat: ON";
btn.className = "btn-success";
status.textContent = "Enabled (3s interval)";
if (ws && ws.readyState === WebSocket.OPEN) {
  startHeartbeat();
}
} else {
btn.textContent = "💔 Heartbeat: OFF";
btn.className = "btn-danger";
status.textContent = "Disabled";
stopHeartbeat();
}
}

function updateDuration() {
if (connectTime) {
const duration = Math.floor((Date.now() - connectTime) / 1000);
document.getElementById('duration').textContent = `${duration}s`;
}
}

function connect() {
if (ws && ws.readyState === WebSocket.OPEN) {
log("Already connected", "warning");
return;
}

log("🔄 Attempting to connect...", "info");
updateStatus('connecting', '🔄 Connecting...');

try {
const url = document.getElementById('serverUrl').textContent;
ws = new WebSocket(url);

// Set up connection timeout
const connectionTimeout = setTimeout(() => {
  if (ws && ws.readyState === WebSocket.CONNECTING) {
    log("❌ Connection timeout (10s)", "error");
    ws.close();
  }
}, 10000);

ws.onopen = () => {
  clearTimeout(connectionTimeout);
  connectTime = Date.now();
  log("✅ WebSocket connected successfully", "success");
  updateStatus('connected', '✅ Connected');
  reconnectAttempts = 0;
  missedHeartbeats = 0;
  
  // Start duration counter
  durationInterval = setInterval(updateDuration, 1000);
  
  // Start heartbeat if enabled
  if (heartbeatEnabled) {
    startHeartbeat();
  }
  
  log("🔍 Connection details:", "info");
  log(`  - URL: ${ws.url}`, "info");
  log(`  - ReadyState: ${ws.readyState}`, "info");
  log(`  - Protocol: ${ws.protocol || 'None'}`, "info");
  log(`  - Extensions: ${ws.extensions || 'None'}`, "info");
};

ws.onmessage = (event) => {
  try {
    const msg = JSON.parse(event.data);
    
    // Reset missed heartbeats on any message
    if (msg.type === 'heartbeat_ack' || msg.type === 'pong') {
      missedHeartbeats = 0;
      document.getElementById('missedHeartbeats').textContent = '0';
    }
    
    log(`📨 Received: <strong>${msg.type}</strong> - ${msg.message || JSON.stringify(msg).substring(0, 100)}`, "success");
    
    // Handle specific message types
    if (msg.type === 'pong') {
      log("🏓 Pong received - connection healthy", "success");
    } else if (msg.type === 'heartbeat_ack') {
      log("💓 Heartbeat acknowledged - connection alive", "success");
    }
  } catch (e) {
    log(`📨 Received raw: ${event.data.substring(0, 200)}${event.data.length > 200 ? '...' : ''}`, "success");
  }
};

ws.onclose = (event) => {
  if (durationInterval) {
    clearInterval(durationInterval);
    durationInterval = null;
  }
  
  // Stop heartbeat
  stopHeartbeat();
  
  let reason = 'Unknown';
  if (event.code === 1000) reason = 'Normal closure';
  else if (event.code === 1001) reason = 'Going away';
  else if (event.code === 1002) reason = 'Protocol error';
  else if (event.code === 1003) reason = 'Unsupported data';
  else if (event.code === 1004) reason = 'Reserved';
  else if (event.code === 1005) reason = 'No status';
  else if (event.code === 1006) reason = 'Abnormal closure';
  else if (event.code === 1007) reason = 'Invalid frame payload';
  else if (event.code === 1008) reason = 'Policy violation';
  else if (event.code === 1009) reason = 'Message too big';
  else if (event.code === 1010) reason = 'Mandatory extension';
  else if (event.code === 1011) reason = 'Internal server error';
  else if (event.code === 1015) reason = 'TLS handshake';
  
  log(`❌ WebSocket disconnected: Code ${event.code} (${reason})`, "error");
  if (event.reason) log(`❌ Reason: ${event.reason}`, "error");
  
  updateStatus('disconnected', '❌ Disconnected');
  document.getElementById('lastError').textContent = `${event.code}: ${reason}`;
  document.getElementById('duration').textContent = '0s';
  
  // Auto-reconnect for abnormal closures
  if (autoReconnect && event.code === 1006 && reconnectAttempts < 5) {
    reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
    log(`🔄 Auto-reconnecting in ${delay/1000}s (attempt ${reconnectAttempts}/5)...`, "warning");
    log(`💡 Tip: Enable heartbeat to prevent idle disconnections!`, "info");
    setTimeout(connect, delay);
  }
};

ws.onerror = (error) => {
  log(`❌ WebSocket error: ${error.type || 'Unknown'}`, "error");
  log(`❌ Error target: ${error.target.readyState}`, "error");
  updateStatus('error', '❌ Error');
  document.getElementById('lastError').textContent = `Error: ${error.type || 'Connection failed'}`;
};

} catch (error) {
log(`❌ Connection failed: ${error.message}`, "error");
updateStatus('disconnected', '❌ Failed');
document.getElementById('lastError').textContent = error.message;
}
}

function disconnect() {
autoReconnect = false;
stopHeartbeat();
if (ws) {
log("🔌 Manually disconnecting...", "warning");
ws.close(1000, "Manual disconnect");
ws = null;
}
}

function sendMessage(message) {
if (!ws || ws.readyState !== WebSocket.OPEN) {
log("❌ Cannot send - not connected", "error");
return false;
}

try {
ws.send(JSON.stringify(message));
messagesSent++;
log(`📤 Sent: <strong>${message.type}</strong> - ${JSON.stringify(message).substring(0, 100)}`, "info");
updateCounters();
return true;
} catch (error) {
log(`❌ Send failed: ${error.message}`, "error");
return false;
}
}

function sendPing() {
sendMessage({type: "ping", timestamp: Date.now()});
}

function sendTest() {
sendMessage({
type: "test", 
data: "Connection test", 
timestamp: Date.now(),
client: "Advanced WebSocket Debugger"
});
}

function sendCustom() {
const input = document.getElementById('customMessage');
try {
const message = JSON.parse(input.value);
sendMessage(message);
} catch (error) {
log(`❌ Invalid JSON: ${error.message}`, "error");
}
}

function clearMessages() {
document.getElementById('messages').innerHTML = '';
messagesSent = 0;
messagesReceived = 0;
errorCount = 0;
updateCounters();
log("🗑️ Message log cleared", "info");
}

// Handle Enter key in custom message input
document.getElementById('customMessage').addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
sendCustom();
}
});

// Initialize when page loads
window.onload = () => {
initDiagnostics();
log("🚀 Advanced WebSocket Debugger loaded", "success");
log("🔍 Run diagnostics and test your connection", "info");

// Auto-connect after a short delay to show the interface first
setTimeout(() => {
log("🔄 Auto-connecting in 2 seconds...", "warning");
setTimeout(connect, 2000);
}, 1000);
};

// Handle page unload
window.onbeforeunload = () => {
if (ws) {
ws.close(1000, "Page unload");
}
};
</script>
</body>
</html>